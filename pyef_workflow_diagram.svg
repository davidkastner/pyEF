<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="1600" height="950" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

  <!-- Define styles -->
  <defs>
    <style type="text/css">
      .title-text { font-family: Arial, sans-serif; font-size: 22px; font-weight: bold; fill: #1a1a1a; }
      .module-name { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; }
      .function-box { fill: #FDB515; stroke: #000000; stroke-width: 2; }
      .file-box { fill: #000000; stroke: #000000; stroke-width: 2; }
      .tool-box { fill: #ffffff; stroke: #000000; stroke-width: 2; }
      .function-text { font-family: Arial, sans-serif; font-size: 11px; fill: #000000; font-weight: bold; }
      .file-text { font-family: Arial, sans-serif; font-size: 10px; fill: #ffffff; font-weight: bold; }
      .small-text { font-family: Arial, sans-serif; font-size: 9px; fill: #000000; }
      .arrow { stroke: #000000; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    </style>

    <!-- Arrow marker -->
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#000000" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="30" class="title-text" text-anchor="middle">pyEF Package Architecture</text>

  <!-- ========== MODULE 1: CLI (Green border) ========== -->
  <rect x="50" y="60" width="320" height="360" rx="15" fill="none" stroke="#16a085" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- CLI Entry -->
  <rect x="70" y="80" width="180" height="35" rx="5" class="file-box"/>
  <text x="160" y="102" class="file-text" text-anchor="middle">$ pyef -c config.yaml</text>
  <path d="M 160,115 L 160,135" class="arrow"/>

  <!-- Config file -->
  <rect x="70" y="135" width="180" height="35" rx="5" class="file-box"/>
  <text x="160" y="157" class="file-text" text-anchor="middle">config.yaml</text>
  <path d="M 160,170 L 160,190" class="arrow"/>

  <!-- Parse config -->
  <rect x="70" y="190" width="180" height="35" rx="5" class="function-box"/>
  <text x="160" y="212" class="function-text" text-anchor="middle">read_config</text>
  <path d="M 160,225 L 160,245" class="arrow"/>

  <!-- Parse jobs -->
  <rect x="70" y="245" width="180" height="35" rx="5" class="function-box"/>
  <text x="160" y="267" class="function-text" text-anchor="middle">parse_job_batch_file</text>
  <path d="M 160,280 L 160,300" class="arrow"/>

  <!-- Job file -->
  <rect x="70" y="300" width="180" height="35" rx="5" class="file-box"/>
  <text x="160" y="322" class="file-text" text-anchor="middle">jobs.csv</text>
  <path d="M 160,335 L 160,355" class="arrow"/>

  <!-- Call main -->
  <rect x="70" y="355" width="180" height="35" rx="5" class="function-box"/>
  <text x="160" y="377" class="function-text" text-anchor="middle">run.main()</text>

  <!-- Module label -->
  <text x="210" y="410" class="module-name" fill="#16a085">pyef.cli</text>

  <!-- Arrow to Python API -->
  <path d="M 250,372 L 440,150" class="arrow"/>

  <!-- ========== MODULE 2: Geometry (Purple border) ========== -->
  <rect x="820" y="60" width="280" height="280" rx="15" fill="none" stroke="#8e44ad" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- Geometry class -->
  <rect x="840" y="80" width="240" height="35" rx="5" class="function-box"/>
  <text x="960" y="102" class="function-text" text-anchor="middle">Geometry(filexyz)</text>
  <path d="M 960,115 L 960,135" class="arrow"/>

  <!-- getGeomInfo -->
  <rect x="840" y="135" width="240" height="35" rx="5" class="function-box"/>
  <text x="960" y="157" class="function-text" text-anchor="middle">getGeomInfo()</text>
  <path d="M 960,170 L 960,190" class="arrow"/>

  <!-- getGeomInfovDW -->
  <rect x="840" y="190" width="240" height="35" rx="5" class="function-box"/>
  <text x="960" y="212" class="function-text" text-anchor="middle">getGeomInfovDW()</text>
  <path d="M 960,225 L 960,245" class="arrow"/>

  <!-- getCentroidDistance -->
  <rect x="840" y="245" width="240" height="35" rx="5" class="function-box"/>
  <text x="960" y="267" class="function-text" text-anchor="middle">getCentroidDistance()</text>

  <!-- Geometry output -->
  <rect x="840" y="290" width="240" height="30" rx="5" class="file-box"/>
  <text x="960" y="308" class="file-text" text-anchor="middle">DataFrame (coords, radii)</text>

  <!-- Module label -->
  <text x="960" y="330" class="module-name" text-anchor="middle" fill="#8e44ad">pyef.geometry</text>

  <!-- ========== MODULE 3: Python API Entry (Blue border) ========== -->
  <rect x="440" y="60" width="320" height="280" rx="15" fill="none" stroke="#2980b9" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- Import -->
  <rect x="460" y="80" width="280" height="35" rx="5" class="function-box"/>
  <text x="600" y="102" class="function-text" text-anchor="middle">from pyef.analysis import Electrostatics</text>
  <path d="M 600,115 L 600,135" class="arrow"/>

  <!-- Initialize -->
  <rect x="460" y="135" width="280" height="35" rx="5" class="function-box"/>
  <text x="600" y="157" class="function-text" text-anchor="middle">es = Electrostatics(...)</text>
  <path d="M 600,170 L 600,190" class="arrow"/>

  <!-- Optional QM/MM -->
  <rect x="460" y="190" width="280" height="35" rx="5" class="function-box"/>
  <text x="600" y="212" class="function-text" text-anchor="middle">es.includePtChgs(file)</text>
  <path d="M 600,225 L 600,245" class="arrow"/>

  <!-- Prep data -->
  <rect x="460" y="245" width="280" height="35" rx="5" class="function-box"/>
  <text x="600" y="267" class="function-text" text-anchor="middle">es.prepData() + es.fix_allECPmolden()</text>

  <!-- Module label -->
  <text x="600" y="330" class="module-name" text-anchor="middle" fill="#2980b9">Python API</text>

  <!-- Arrow to analysis -->
  <path d="M 600,280 L 600,420" class="arrow"/>

  <!-- ========== MODULE: QM/MM Integration (Orange border) ========== -->
  <rect x="1120" y="420" width="420" height="220" rx="15" fill="none" stroke="#e67e22" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- Point charge file -->
  <rect x="1150" y="445" width="160" height="30" rx="5" class="file-box"/>
  <text x="1230" y="463" class="file-text" text-anchor="middle">ptchg.dat / MM region</text>
  <path d="M 1230,475 L 1230,495" class="arrow"/>

  <!-- includePtChgs -->
  <rect x="1150" y="495" width="160" height="35" rx="5" class="function-box"/>
  <text x="1230" y="517" class="function-text" text-anchor="middle">includePtChgs(file)</text>
  <path d="M 1230,530 L 1230,550" class="arrow"/>

  <!-- getPtChgs -->
  <rect x="1150" y="550" width="160" height="35" rx="5" class="function-box"/>
  <text x="1230" y="572" class="function-text" text-anchor="middle">getPtChgs()</text>

  <!-- Point charge output -->
  <rect x="1150" y="595" width="160" height="30" rx="5" class="file-box"/>
  <text x="1230" y="613" class="file-text" text-anchor="middle">MM charges (x,y,z,q)</text>

  <!-- QM/MM description -->
  <rect x="1330" y="445" width="190" height="180" rx="5" fill="none" stroke="#d35400" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="1425" y="465" class="small-text" text-anchor="middle" font-weight="bold">QM/MM Workflow:</text>
  <text x="1425" y="485" class="small-text" text-anchor="middle">1. QM region: DFT calc</text>
  <text x="1425" y="500" class="small-text" text-anchor="middle">   → Multiwfn charges</text>
  <text x="1425" y="520" class="small-text" text-anchor="middle">2. MM region: Force field</text>
  <text x="1425" y="535" class="small-text" text-anchor="middle">   → Point charges</text>
  <text x="1425" y="555" class="small-text" text-anchor="middle">3. Combined ESP/E-field</text>
  <text x="1425" y="570" class="small-text" text-anchor="middle">   calculation includes</text>
  <text x="1425" y="585" class="small-text" text-anchor="middle">   both QM + MM</text>
  <text x="1425" y="605" class="small-text" text-anchor="middle">4. Dielectric scaling</text>
  <text x="1425" y="620" class="small-text" text-anchor="middle">   adjusts MM charges</text>

  <!-- Module label -->
  <text x="1330" y="630" class="module-name" text-anchor="middle" fill="#e67e22">QM/MM Integration</text>

  <!-- Arrow from QM/MM to analysis methods -->
  <path d="M 1150,520 L 950,520" class="arrow" stroke-dasharray="5,3"/>

  <!-- ========== MODULE 4: Analysis Methods (Teal border) ========== -->
  <rect x="50" y="420" width="900" height="220" rx="15" fill="none" stroke="#16a085" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- ESP -->
  <rect x="80" y="445" width="150" height="80" rx="5" class="function-box"/>
  <text x="155" y="465" class="function-text" text-anchor="middle">getESP</text>
  <text x="155" y="480" class="small-text" text-anchor="middle">Step 1: Get charges</text>
  <text x="155" y="495" class="small-text" text-anchor="middle">Step 2: Compute</text>
  <text x="155" y="510" class="small-text" text-anchor="middle">V(r) = Σ q_i/r_i</text>

  <rect x="80" y="530" width="150" height="30" rx="5" class="file-box"/>
  <text x="155" y="548" class="file-text" text-anchor="middle">ESP.csv</text>

  <!-- E-field -->
  <rect x="270" y="445" width="150" height="80" rx="5" class="function-box"/>
  <text x="345" y="465" class="function-text" text-anchor="middle">getEfield</text>
  <text x="345" y="480" class="small-text" text-anchor="middle">Step 1: Get charges</text>
  <text x="345" y="495" class="small-text" text-anchor="middle">Step 2: Compute</text>
  <text x="345" y="510" class="small-text" text-anchor="middle">E(r) = Σ q_i·r̂_i/r_i²</text>

  <rect x="270" y="530" width="150" height="30" rx="5" class="file-box"/>
  <text x="345" y="548" class="file-text" text-anchor="middle">Efield.csv</text>

  <!-- Stabilization -->
  <rect x="460" y="445" width="180" height="80" rx="5" class="function-box"/>
  <text x="550" y="460" class="function-text" text-anchor="middle">get_Electrostatic</text>
  <text x="550" y="473" class="function-text" text-anchor="middle">_stabilization</text>
  <text x="550" y="488" class="small-text" text-anchor="middle">Step 1: Get multipoles</text>
  <text x="550" y="503" class="small-text" text-anchor="middle">Step 2: Compute</text>
  <text x="550" y="518" class="small-text" text-anchor="middle">E = M_i·T·M_j</text>

  <rect x="460" y="530" width="180" height="30" rx="5" class="file-box"/>
  <text x="550" y="548" class="file-text" text-anchor="middle">stabilization.csv</text>

  <!-- partitionCharge call indicator -->
  <rect x="680" y="445" width="240" height="115" rx="5" fill="none" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,3"/>
  <text x="800" y="465" class="function-text" text-anchor="middle" fill="#e74c3c">All methods call:</text>
  <text x="800" y="485" class="function-text" text-anchor="middle">partitionCharge()</text>
  <text x="800" y="505" class="small-text" text-anchor="middle">↓ Request charges ↓</text>
  <text x="800" y="525" class="small-text" text-anchor="middle">↑ Return charges ↑</text>
  <text x="800" y="545" class="small-text" text-anchor="middle">to Multiwfn interface</text>

  <!-- Module label -->
  <text x="500" y="625" class="module-name" text-anchor="middle" fill="#16a085">pyef.analysis.Electrostatics</text>

  <!-- Arrows to Multiwfn -->
  <path d="M 155,525 L 155,670" class="arrow"/>
  <path d="M 345,525 L 345,670" class="arrow"/>
  <path d="M 550,525 L 550,670" class="arrow"/>

  <!-- ========== MODULE 5: Multiwfn Interface (Red border) ========== -->
  <rect x="50" y="670" width="900" height="220" rx="15" fill="none" stroke="#c0392b" stroke-width="3" stroke-dasharray="10,5"/>

  <!-- MultiwfnInterface class -->
  <rect x="80" y="695" width="200" height="35" rx="5" class="function-box"/>
  <text x="180" y="717" class="function-text" text-anchor="middle">MultiwfnInterface</text>
  <path d="M 180,730 L 180,750" class="arrow"/>

  <!-- run_multiwfn -->
  <rect x="80" y="750" width="200" height="35" rx="5" class="function-box"/>
  <text x="180" y="772" class="function-text" text-anchor="middle">run_multiwfn()</text>

  <!-- Input files -->
  <rect x="80" y="795" width="85" height="30" rx="5" class="file-box"/>
  <text x="122" y="813" class="file-text" text-anchor="middle">.molden</text>

  <rect x="175" y="795" width="85" height="30" rx="5" class="file-box"/>
  <text x="217" y="813" class="file-text" text-anchor="middle">.xyz</text>

  <!-- External Multiwfn -->
  <rect x="310" y="695" width="180" height="35" rx="5" class="tool-box"/>
  <text x="400" y="717" class="function-text" text-anchor="middle">Multiwfn executable</text>
  <text x="400" y="735" class="small-text" text-anchor="middle">(external program)</text>

  <!-- partitionCharge -->
  <rect x="310" y="750" width="180" height="75" rx="5" class="function-box"/>
  <text x="400" y="770" class="function-text" text-anchor="middle">partitionCharge()</text>
  <text x="400" y="788" class="small-text" text-anchor="middle">Schemes: Hirshfeld_I,</text>
  <text x="400" y="803" class="small-text" text-anchor="middle">CHELPG, Becke, AIM...</text>
  <text x="400" y="818" class="small-text" text-anchor="middle">Orders: 1, 2, 3</text>

  <!-- getmultipoles -->
  <rect x="520" y="695" width="180" height="35" rx="5" class="function-box"/>
  <text x="610" y="717" class="function-text" text-anchor="middle">getmultipoles()</text>

  <!-- Charge data structures -->
  <rect x="520" y="750" width="180" height="35" rx="5" class="function-box"/>
  <text x="610" y="772" class="function-text" text-anchor="middle">CHARGE_SCHEMES</text>

  <rect x="520" y="795" width="180" height="30" rx="5" class="function-box"/>
  <text x="610" y="813" class="function-text" text-anchor="middle">MULTIPOLE_SCHEMES</text>

  <!-- Output -->
  <rect x="730" y="740" width="85" height="30" rx="5" class="file-box"/>
  <text x="772" y="758" class="file-text" text-anchor="middle">charges</text>

  <rect x="825" y="740" width="85" height="30" rx="5" class="file-box"/>
  <text x="867" y="758" class="file-text" text-anchor="middle">multipoles</text>

  <!-- Return arrows -->
  <path d="M 772,740 L 772,570 L 155,570 L 155,525" class="arrow"/>
  <path d="M 820,740 L 820,600 L 345,600 L 345,525" class="arrow"/>
  <path d="M 867,740 L 867,590 L 550,590 L 550,525" class="arrow"/>

  <!-- Module label -->
  <text x="500" y="880" class="module-name" text-anchor="middle" fill="#c0392b">pyef.multiwfn_interface</text>

  <!-- ========== Data flow indicators ========== -->
  <!-- Data nodes -->
  <circle cx="1150" y="150" r="35" fill="#000000"/>
  <text x="1150" y="155" class="file-text" text-anchor="middle">config</text>
  <text x="1150" y="165" class="file-text" text-anchor="middle">YAML</text>

  <circle cx="1150" y="300" r="35" fill="#000000"/>
  <text x="1150" y="305" class="file-text" text-anchor="middle">jobs</text>
  <text x="1150" y="315" class="file-text" text-anchor="middle">CSV</text>

  <circle cx="1150" y="380" r="35" fill="#000000"/>
  <text x="1150" y="380" class="file-text" text-anchor="middle">XYZ</text>
  <text x="1150" y="392" class="file-text" text-anchor="middle">coords</text>

  <circle cx="1150" y="870" r="35" fill="#000000"/>
  <text x="1150" y="870" class="file-text" text-anchor="middle">QM</text>
  <text x="1150" y="882" class="file-text" text-anchor="middle">charges</text>

  <!-- Arrows showing data flow -->
  <path d="M 760,305 L 820,305 L 820,150 L 1115,150" class="arrow" stroke-dasharray="3,2"/>
  <path d="M 250,320 L 1050,320 L 1050,300 L 1115,300" class="arrow" stroke-dasharray="3,2"/>
  <path d="M 960,320 L 960,380 L 1115,380" class="arrow" stroke-dasharray="3,2"/>

</svg>
